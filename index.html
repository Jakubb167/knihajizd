<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kniha j√≠zd - Profesion√°ln√≠ port√°l</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: #1e293b; color: white; padding: 30px 0; z-index: 200; overflow-y: auto; }
        .sidebar h2 { padding: 0 25px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin: 5px 15px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; cursor: pointer; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: #2563eb; color: white; }
        .header { position: fixed; top: 0; left: 280px; right: 0; height: 70px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 100; }
        .main-content { margin-left: 280px; margin-top: 70px; padding: 30px; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-card-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .chart-container.full-width { grid-column: 1 / -1; }
        .chart-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: #f8fafc; font-weight: 700; }
        .refresh-btn { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .refresh-btn:hover { background: #1d4ed8; }
        
        /* Year Heatmap Styles */
        .heatmap-container { display: inline-block; }
        .heatmap-months { display: grid; grid-template-columns: 40px repeat(53, 12px); gap: 3px; margin-bottom: 5px; font-size: 11px; color: #64748b; }
        .heatmap-weeks { display: grid; grid-template-columns: 40px repeat(53, 12px); gap: 3px; }
        .heatmap-day-labels { display: flex; flex-direction: column; gap: 3px; font-size: 10px; color: #64748b; padding-top: 2px; }
        .heatmap-day-label { height: 12px; display: flex; align-items: center; }
        .heatmap-week { display: flex; flex-direction: column; gap: 3px; }
        .heatmap-day { width: 12px; height: 12px; border-radius: 2px; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(27, 31, 35, 0.06); }
        .heatmap-day:hover { border: 1px solid rgba(27, 31, 35, 0.3); transform: scale(1.3); z-index: 10; }
        .heatmap-day.level-0 { background: #ebedf0; }
        .heatmap-day.level-1 { background: #9be9a8; }
        .heatmap-day.level-2 { background: #40c463; }
        .heatmap-day.level-3 { background: #30a14e; }
        .heatmap-day.level-4 { background: #216e39; }
        .heatmap-tooltip { position: absolute; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 1000; white-space: nowrap; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        
        /* Stat cards improvements */
        .stat-mini-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-mini-card.blue { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .stat-mini-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-mini-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-mini-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        
        /* Calendar Styles */
        .calendar-container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; margin-bottom: 30px; }
        .calendar-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header h3 { font-size: 18px; margin: 0; }
        .calendar-nav-btn { background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .calendar-nav-btn:hover { background: #1d4ed8; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-header { text-align: center; font-weight: 700; padding: 8px; color: #64748b; font-size: 12px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 60px; transition: all 0.2s; position: relative; }
        .calendar-day:hover { background: #f1f5f9; border-color: #2563eb; }
        .calendar-day.today { background: #eff6ff; border-color: #2563eb; font-weight: 700; color: #2563eb; }
        .calendar-day.has-trips { background: #fafafa; }
        .calendar-day.selected { background: #dbeafe; border-color: #2563eb; border-width: 2px; }
        .day-number { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .vehicle-dots { display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; max-width: 100%; padding: 0 2px; }
        .vehicle-dot { width: 6px; height: 6px; border-radius: 50%; }
        
        /* Day detail panel */
        .day-detail-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-height: 700px; overflow-y: auto; }
        .day-detail-empty { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .day-detail-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .day-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 12px; background: #f1f5f9; border-radius: 8px; margin-bottom: 15px; }
        .day-stat { text-align: center; }
        .day-stat-label { font-size: 11px; color: #64748b; margin-bottom: 3px; }
        .day-stat-value { font-size: 20px; font-weight: 700; }
        .trip-card { padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #2563eb; }
        .trip-vehicle { font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .trip-km { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .trip-route { font-size: 12px; color: #64748b; line-height: 1.6; }
        
        /* Filter styles */
        .filter-group { display: flex; gap: 15px; align-items: center; }
        .filter-group label { font-size: 14px; font-weight: 600; color: #64748b; }
        .filter-group select, .filter-group input { padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üöõ Kniha j√≠zd</h2>
        <div class="nav-link active" data-section="dashboard">üìä Dashboard</div>
        <div class="nav-link" data-section="vehicles">üöö Vozidla</div>
        <div class="nav-link" data-section="calendar">üìÖ Kalend√°≈ô</div>
        <div class="nav-link" data-section="trips">üìù V≈°echny j√≠zdy</div>
        <div class="nav-link" data-section="analytics">üìà Analytika</div>
    </div>

    <div class="header">
        <h1>Dashboard</h1>
        <div class="filter-group">
            <label>Vozidlo:</label>
            <select id="vehicleFilter">
                <option value="">V≈°echna vozidla</option>
                <option value="cervene-iveco">ƒåerven√© Iveco</option>
                <option value="iveco-mysak">Iveco My≈°√°k</option>
                <option value="atego">Atego</option>
                <option value="peugeot">Peugeot</option>
            </select>
            <input type="date" id="dateFrom">
            <span>‚Äî</span>
            <input type="date" id="dateTo">
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Obnovit</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div class="content-section active" id="section-dashboard">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">CELKEM KM</div>
                    <div class="stat-card-value" id="totalKm">0 km</div>
                    <div style="color: #64748b; font-size: 13px;">za vybran√© obdob√≠</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">POƒåET J√çZD</div>
                    <div class="stat-card-value" id="totalTrips">0</div>
                    <div style="color: #64748b; font-size: 13px;">dokonƒçen√Ωch tras</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">P≈òEPRAVENO PALET</div>
                    <div class="stat-card-value" id="totalPallets">0</div>
                    <div style="color: #64748b; font-size: 13px;">celkov√Ω objem</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">PR≈ÆMƒöR KM/J√çZDA</div>
                    <div class="stat-card-value" id="avgKm">0 km</div>
                    <div style="color: #64748b; font-size: 13px;">pr≈Ømƒõr na j√≠zdu</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Ujet√© kilometry dle vozidel</h3>
                    <canvas id="vehicleKmChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Rozlo≈æen√≠ j√≠zd</h3>
                    <canvas id="vehicleTripsChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Denn√≠ p≈ôehled kilometr≈Ø</h3>
                <canvas id="dailyKmChart"></canvas>
            </div>

            <div class="chart-container full-width" style="margin-top: 30px;">
                <h3 class="chart-title">üìà V√Ωvoj stavu kilometr≈Ø vozidel</h3>
                <canvas id="kmStateChart"></canvas>
            </div>

            <div class="charts-grid" style="margin-top: 30px;">
                <div class="chart-container">
                    <h3 class="chart-title">P≈ôeprava palet v ƒçase</h3>
                    <canvas id="palletsTimeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Pr≈Ømƒõrn√° d√©lka j√≠zdy</h3>
                    <canvas id="avgTripLengthChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Top 10 nejƒçastƒõj≈°√≠ch destinac√≠</h3>
                <canvas id="topDestinationsChartDash"></canvas>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Aktivita podle dn≈Ø v t√Ωdnu</h3>
                    <canvas id="weekdayActivityChartDash"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Vyu≈æit√≠ vozidel (%)</h3>
                    <canvas id="vehicleUtilizationChartDash"></canvas>
                </div>
            </div>
        </div>

        <!-- Vehicles Section -->
        <div class="content-section" id="section-vehicles">
            <h2 style="margin-bottom: 25px;">P≈ôehled vozidel</h2>
            <div id="vehicleStats"></div>
        </div>

        <!-- Calendar Section -->
        <div class="content-section" id="section-calendar">
            <h2 style="margin-bottom: 25px;">üìÖ Kalend√°≈ô j√≠zd</h2>
            <div class="calendar-container">
                <div class="calendar-box">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
                        <h3 id="calendarMonthYear"></h3>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <div class="day-detail-panel">
                    <div id="dayDetailContent" class="day-detail-empty">
                        <div style="font-size: 64px; margin-bottom: 15px; opacity: 0.5;">üìÖ</div>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">Vyberte den</p>
                        <p style="font-size: 13px;">Kliknƒõte na datum v kalend√°≈ôi</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trips Section -->
        <div class="content-section" id="section-trips">
            <h2 style="margin-bottom: 25px;">V≈°echny j√≠zdy</h2>
            <div style="background: white; border-radius: 12px; overflow: hidden;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Vozidlo</th>
                            <th>Poƒç√°teƒçn√≠ km</th>
                            <th>Koneƒçn√Ω km</th>
                            <th>Ujeto km</th>
                            <th>Celkem palet</th>
                            <th>M√≠sto</th>
                            <th>Palety</th>
                        </tr>
                    </thead>
                    <tbody id="tripsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="content-section" id="section-analytics">
            <h2 style="margin-bottom: 25px;">Pokroƒçil√° analytika</h2>
            
            <!-- Roƒçn√≠ heatmapa -->
            <div class="chart-container full-width" style="margin-bottom: 30px;">
                <h3 class="chart-title">Roƒçn√≠ heatmapa najet√Ωch kilometr≈Ø</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <select id="heatmapYear" onchange="generateYearHeatmap(this.value)" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <option value="2026">2026</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center; font-size: 12px; color: #64748b;">
                        <span>M√©nƒõ</span>
                        <div style="display: flex; gap: 3px;">
                            <div style="width: 15px; height: 15px; background: #ebedf0; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #9be9a8; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #40c463; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #30a14e; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #216e39; border-radius: 2px;"></div>
                        </div>
                        <span>V√≠ce</span>
                    </div>
                </div>
                <div id="yearHeatmap" style="overflow-x: auto; padding: 20px; background: #f8fafc; border-radius: 8px;"></div>
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Celkem dn≈Ø s j√≠zdami</div>
                        <div style="font-size: 24px; font-weight: 700;" id="heatmapActiveDays">0</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Nejaktivnƒõj≈°√≠ den</div>
                        <div style="font-size: 24px; font-weight: 700;" id="heatmapMaxDay">-</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Max km za den</div>
                        <div style="font-size: 24px; font-weight: 700;" id="heatmapMaxKm">0 km</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Pr≈Ømƒõr km/aktivn√≠ den</div>
                        <div style="font-size: 24px; font-weight: 700;" id="heatmapAvgKm">0 km</div>
                    </div>
                </div>
            </div>

            <!-- Mini statistiky -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="stat-mini-card blue">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Nejdel≈°√≠ j√≠zda</div>
                    <div style="font-size: 28px; font-weight: 700;" id="longestTrip">0 km</div>
                </div>
                <div class="stat-mini-card green">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Nejv√≠ce palet/den</div>
                    <div style="font-size: 28px; font-weight: 700;" id="maxPalletsDay">0</div>
                </div>
                <div class="stat-mini-card orange">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Nejv√≠ce zast√°vek</div>
                    <div style="font-size: 28px; font-weight: 700;" id="maxStops">0</div>
                </div>
                <div class="stat-mini-card purple">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Pr≈Ømƒõr zast√°vek</div>
                    <div style="font-size: 28px; font-weight: 700;" id="avgStops">0</div>
                </div>
            </div>

            <!-- Pokroƒçil√© grafy -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Aktivita podle dn≈Ø v t√Ωdnu</h3>
                    <canvas id="weekdayActivityChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Hodiny odjet√≠ (timeline)</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Mƒõs√≠ƒçn√≠ srovn√°n√≠ - Kilometry vs J√≠zdy vs Palety</h3>
                <canvas id="monthlyComparisonChart"></canvas>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Distribuce d√©lek j√≠zd</h3>
                    <canvas id="distanceDistributionChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Efektivita - Palety na km</h3>
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Top 15 nejƒçastƒõj≈°√≠ch destinac√≠</h3>
                <canvas id="topDestinationsChart"></canvas>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Vyu≈æit√≠ vozidel (%)</h3>
                    <canvas id="vehicleUtilizationChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Kumulativn√≠ kilometry</h3>
                    <canvas id="cumulativeKmChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://knihajizd.baborovsky-jakub.workers.dev';
        let allTripsData = [];
        let filteredTripsData = [];
        const charts = {};
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;

        const vehicleNames = {
            'cervene-iveco': 'ƒåerven√© Iveco',
            'iveco-mysak': 'Iveco My≈°√°k',
            'atego': 'Atego',
            'peugeot': 'Peugeot'
        };

        const vehicleColors = {
            'cervene-iveco': '#dc2626',
            'iveco-mysak': '#6b7280',
            'atego': '#64748b',
            'peugeot': '#1f2937'
        };

        // Initialize
        function initializeDateRange() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            document.getElementById('dateFrom').value = formatDateForInput(thirtyDaysAgo);
            document.getElementById('dateTo').value = formatDateForInput(today);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
                document.querySelector('.header h1').textContent = this.textContent.trim();
                loadSectionData(section);
            });
        });

        function loadSectionData(section) {
            switch(section) {
                case 'dashboard': updateDashboard(); break;
                case 'vehicles': loadVehiclesSection(); break;
                case 'calendar': loadCalendarSection(); break;
                case 'trips': loadTripsSection(); break;
                case 'analytics': updateAnalytics(); break;
            }
        }

        // Load data
        async function loadAllData() {
            try {
                const response = await fetch(`${API_URL}/get_trips.php`);
                const result = await response.json();
                if (result.success) {
                    allTripsData = result.trips;
                    filterDataByDateRange();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Chyba p≈ôi naƒç√≠t√°n√≠ dat: ' + error.message);
            }
        }

        function filterDataByDateRange() {
            const dateFrom = new Date(document.getElementById('dateFrom').value);
            const dateTo = new Date(document.getElementById('dateTo').value);
            dateTo.setHours(23, 59, 59);
            
            const selectedVehicle = document.getElementById('vehicleFilter').value;
            
            filteredTripsData = allTripsData.filter(trip => {
                const tripDate = new Date(trip.date);
                const dateMatch = tripDate >= dateFrom && tripDate <= dateTo;
                const vehicleMatch = !selectedVehicle || trip.vehicle === selectedVehicle;
                return dateMatch && vehicleMatch;
            });
        }

        // Dashboard
        function updateDashboard() {
            const totalKm = filteredTripsData.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
            const totalPallets = filteredTripsData.reduce((sum, t) => sum + t.totalPallets, 0);
            const avgKm = filteredTripsData.length > 0 ? (totalKm / filteredTripsData.length).toFixed(1) : 0;

            document.getElementById('totalKm').textContent = totalKm.toLocaleString('cs-CZ') + ' km';
            document.getElementById('totalTrips').textContent = filteredTripsData.length;
            document.getElementById('totalPallets').textContent = totalPallets.toLocaleString('cs-CZ');
            document.getElementById('avgKm').textContent = avgKm + ' km';

            updateVehicleKmChart();
            updateVehicleTripsChart();
            updateDailyKmChart();
            updateKmStateChart();
            updatePalletsTimeChart();
            updateAvgTripLengthChart();
            updateTopDestinationsChartDash();
            updateWeekdayActivityChartDash();
            updateVehicleUtilizationChartDash();
        }

        function updateKmStateChart() {
            const ctx = document.getElementById('kmStateChart');
            if (!ctx) return;
            
            const vehicleData = {};
            Object.keys(vehicleNames).forEach(v => vehicleData[v] = {});
            
            allTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                if (!vehicleData[trip.vehicle][date] || trip.kmEnd > vehicleData[trip.vehicle][date]) {
                    vehicleData[trip.vehicle][date] = trip.kmEnd;
                }
            });
            
            const today = new Date();
            const dates = [];
            for (let i = 89; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }
            
            const labels = dates.map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' }));
            
            const datasets = Object.keys(vehicleNames).map(vehicleId => {
                const data = [];
                let lastKnownKm = null;
                
                dates.forEach(date => {
                    if (vehicleData[vehicleId][date]) {
                        lastKnownKm = vehicleData[vehicleId][date];
                        data.push(lastKnownKm);
                    } else {
                        data.push(lastKnownKm);
                    }
                });
                
                return {
                    label: vehicleNames[vehicleId],
                    data: data,
                    borderColor: vehicleColors[vehicleId],
                    backgroundColor: vehicleColors[vehicleId] + '22',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 1,
                    pointHoverRadius: 5
                };
            });

            if (charts.kmState) charts.kmState.destroy();

            charts.kmState = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y ? context.parsed.y.toLocaleString('cs-CZ') + ' km' : 'Bez dat');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('cs-CZ') + ' km';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopDestinationsChartDash() {
            const ctx = document.getElementById('topDestinationsChartDash');
            if (!ctx) return;
            
            const destinations = {};
            filteredTripsData.forEach(trip => {
                trip.locations.forEach(loc => {
                    destinations[loc.place] = (destinations[loc.place] || 0) + 1;
                });
            });

            const sorted = Object.entries(destinations).sort((a, b) => b[1] - a[1]).slice(0, 10);

            if (charts.topDestDash) charts.topDestDash.destroy();
            
            charts.topDestDash = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        label: 'N√°v≈°tƒõv',
                        data: sorted.map(d => d[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateWeekdayActivityChartDash() {
            const ctx = document.getElementById('weekdayActivityChartDash');
            if (!ctx) return;
            
            const weekdays = ['Nedƒõle', 'Pondƒõl√≠', '√öter√Ω', 'St≈ôeda', 'ƒåtvrtek', 'P√°tek', 'Sobota'];
            const counts = new Array(7).fill(0);
            const kms = new Array(7).fill(0);
            
            filteredTripsData.forEach(trip => {
                const day = new Date(trip.date).getDay();
                counts[day]++;
                kms[day] += trip.kmEnd - trip.kmStart;
            });

            if (charts.weekdayActivityDash) charts.weekdayActivityDash.destroy();
            
            charts.weekdayActivityDash = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [
                        {
                            label: 'Poƒçet j√≠zd',
                            data: counts,
                            backgroundColor: '#2563eb',
                            borderRadius: 6
                        },
                        {
                            label: 'Kilometry',
                            data: kms,
                            backgroundColor: '#10b981',
                            borderRadius: 6
                        }
                    ]
                },
                options: { responsive: true }
            });
        }

        function updateVehicleUtilizationChartDash() {
            const ctx = document.getElementById('vehicleUtilizationChartDash');
            if (!ctx) return;
            
            const totalDays = 30;
            const utilization = {};
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const uniqueDays = new Set(vTrips.map(t => t.date.split('T')[0])).size;
                utilization[v] = (uniqueDays / totalDays) * 100;
            });

            if (charts.vehicleUtilDash) charts.vehicleUtilDash.destroy();
            
            charts.vehicleUtilDash = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(utilization).map(v => vehicleNames[v]),
                    datasets: [{
                        data: Object.values(utilization),
                        backgroundColor: Object.keys(utilization).map(v => vehicleColors[v])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateVehicleKmChart() {
            const ctx = document.getElementById('vehicleKmChart');
            if (!ctx) return;
            
            const vehicleData = {};
            Object.keys(vehicleNames).forEach(v => vehicleData[v] = 0);
            filteredTripsData.forEach(trip => {
                vehicleData[trip.vehicle] += (trip.kmEnd - trip.kmStart);
            });

            if (charts.vehicleKm) charts.vehicleKm.destroy();
            
            charts.vehicleKm = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vehicleData).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Kilometry',
                        data: Object.values(vehicleData),
                        backgroundColor: Object.keys(vehicleData).map(v => vehicleColors[v]),
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateVehicleTripsChart() {
            const ctx = document.getElementById('vehicleTripsChart');
            if (!ctx) return;
            
            const vehicleTrips = {};
            Object.keys(vehicleNames).forEach(v => vehicleTrips[v] = 0);
            filteredTripsData.forEach(trip => {
                vehicleTrips[trip.vehicle]++;
            });

            if (charts.vehicleTrips) charts.vehicleTrips.destroy();

            charts.vehicleTrips = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(vehicleTrips).map(v => vehicleNames[v]),
                    datasets: [{
                        data: Object.values(vehicleTrips),
                        backgroundColor: Object.keys(vehicleTrips).map(v => vehicleColors[v])
                    }]
                },
                options: { responsive: true }
            });
        }

        function updateDailyKmChart() {
            const ctx = document.getElementById('dailyKmChart');
            if (!ctx) return;
            
            const dailyData = {};
            filteredTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                dailyData[date] = (dailyData[date] || 0) + (trip.kmEnd - trip.kmStart);
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' }));

            if (charts.dailyKm) charts.dailyKm.destroy();

            charts.dailyKm = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kilometry',
                        data: sortedDates.map(d => dailyData[d]),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updatePalletsTimeChart() {
            const ctx = document.getElementById('palletsTimeChart');
            if (!ctx) return;
            
            const dailyPallets = {};
            filteredTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                dailyPallets[date] = (dailyPallets[date] || 0) + trip.totalPallets;
            });
            
            const sortedDates = Object.keys(dailyPallets).sort();
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' }));

            if (charts.palletsTime) charts.palletsTime.destroy();
            
            charts.palletsTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Palety',
                        data: sortedDates.map(d => dailyPallets[d]),
                        backgroundColor: '#f59e0b',
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateAvgTripLengthChart() {
            const ctx = document.getElementById('avgTripLengthChart');
            if (!ctx) return;
            
            const vehicleAvg = {};
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const totalKm = vTrips.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
                vehicleAvg[v] = vTrips.length > 0 ? totalKm / vTrips.length : 0;
            });

            if (charts.avgTripLength) charts.avgTripLength.destroy();
            
            charts.avgTripLength = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vehicleAvg).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Pr≈Ømƒõrn√° d√©lka (km)',
                        data: Object.values(vehicleAvg),
                        backgroundColor: Object.keys(vehicleAvg).map(v => vehicleColors[v]),
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // Vehicles Section
        function loadVehiclesSection() {
            const container = document.getElementById('vehicleStats');
            if (!container) return;
            
            container.innerHTML = '';
            Object.keys(vehicleNames).forEach(vehicleId => {
                const vehicleTrips = filteredTripsData.filter(t => t.vehicle === vehicleId);
                const totalKm = vehicleTrips.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
                const totalPallets = vehicleTrips.reduce((sum, t) => sum + t.totalPallets, 0);
                const avgKm = vehicleTrips.length > 0 ? (totalKm / vehicleTrips.length).toFixed(1) : 0;
                
                container.innerHTML += `
                    <div class="stat-card" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                            <div style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; color: white; background: ${vehicleColors[vehicleId]}">
                                ${vehicleNames[vehicleId].substring(0, 2)}
                            </div>
                            <div>
                                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${vehicleNames[vehicleId]}</h3>
                                <p style="font-size: 13px; color: #64748b;">${vehicleTrips.length} j√≠zd celkem</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 5px;">Celkem km</div>
                                <div style="font-size: 20px; font-weight: 700;">${totalKm.toLocaleString('cs-CZ')}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 5px;">Pr≈Ømƒõr km/j√≠zda</div>
                                <div style="font-size: 20px; font-weight: 700;">${avgKm}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 5px;">Celkem palet</div>
                                <div style="font-size: 20px; font-weight: 700;">${totalPallets.toLocaleString('cs-CZ')}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 5px;">Pr≈Ømƒõr palet/j√≠zda</div>
                                <div style="font-size: 20px; font-weight: 700;">${vehicleTrips.length > 0 ? (totalPallets / vehicleTrips.length).toFixed(1) : 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Calendar Section
        function loadCalendarSection() {
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthNames = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven', 'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
            
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Day headers
            ['Po', '√öt', 'St', 'ƒåt', 'P√°', 'So', 'Ne'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Empty cells
            for (let i = 0; i < startDay; i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            // Days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayTrips = allTripsData.filter(t => t.date.startsWith(dateStr));
                const isToday = date.toDateString() === today.toDateString();
                const isSelected = selectedCalendarDay === dateStr;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (isToday) dayDiv.classList.add('today');
                if (dayTrips.length > 0) dayDiv.classList.add('has-trips');
                if (isSelected) dayDiv.classList.add('selected');
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);
                
                if (dayTrips.length > 0) {
                    const vehicles = [...new Set(dayTrips.map(t => t.vehicle))];
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'vehicle-dots';
                    
                    vehicles.forEach(vehicle => {
                        const dot = document.createElement('div');
                        dot.className = 'vehicle-dot';
                        dot.style.background = vehicleColors[vehicle];
                        dotsContainer.appendChild(dot);
                    });
                    
                    dayDiv.appendChild(dotsContainer);
                }
                
                dayDiv.onclick = () => showDayDetail(dateStr, dayTrips);
                grid.appendChild(dayDiv);
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function showDayDetail(dateStr, trips) {
            selectedCalendarDay = dateStr;
            renderCalendar(); // Re-render to show selection
            
            const date = new Date(dateStr);
            const formatted = date.toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const container = document.getElementById('dayDetailContent');
            
            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="day-detail-empty">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">${formatted}</p>
                        <p style="font-size: 13px;">≈Ω√°dn√© j√≠zdy</p>
                    </div>
                `;
                return;
            }
            
            const totalKm = trips.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
            const totalPallets = trips.reduce((sum, t) => sum + t.totalPallets, 0);
            
            let html = `
                <div class="day-detail-title">${formatted}</div>
                <div class="day-stats">
                    <div class="day-stat">
                        <div class="day-stat-label">J√çZD</div>
                        <div class="day-stat-value" style="color: #2563eb;">${trips.length}</div>
                    </div>
                    <div class="day-stat">
                        <div class="day-stat-label">KM</div>
                        <div class="day-stat-value" style="color: #10b981;">${totalKm.toLocaleString('cs-CZ')}</div>
                    </div>
                    <div class="day-stat">
                        <div class="day-stat-label">PALETY</div>
                        <div class="day-stat-value" style="color: #f59e0b;">${totalPallets.toLocaleString('cs-CZ')}</div>
                    </div>
                </div>
            `;
            
            trips.forEach(trip => {
                const km = trip.kmEnd - trip.kmStart;
                const route = trip.locations.map(l => {
                    let text = l.place;
                    if (l.time) text += ` (${l.time})`;
                    if (l.pallets) text += ` ‚Ä¢ ${l.pallets} palet`;
                    return text;
                }).join('<br>‚Üí ');
                
                html += `
                    <div class="trip-card" style="border-left-color: ${vehicleColors[trip.vehicle]}">
                        <div class="trip-vehicle">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${vehicleColors[trip.vehicle]}"></div>
                            ${trip.vehicleName}
                        </div>
                        <div class="trip-km">
                            ${trip.kmStart.toLocaleString('cs-CZ')} ‚Üí ${trip.kmEnd.toLocaleString('cs-CZ')} km 
                            <strong style="color: #2563eb;">(${km.toLocaleString('cs-CZ')} km)</strong>
                        </div>
                        ${trip.totalPallets > 0 ? `<div style="font-size: 13px; color: #f59e0b; margin-bottom: 8px; font-weight: 600;">üì¶ ${trip.totalPallets} palet celkem</div>` : ''}
                        <div class="trip-route">${route}</div>
                        ${trip.notes ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b; font-style: italic;">üí¨ ${trip.notes}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Trips Section
        function loadTripsSection() {
            const tbody = document.getElementById('tripsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            filteredTripsData.forEach(trip => {
                const date = new Date(trip.date).toLocaleDateString('cs-CZ');
                const km = trip.kmEnd - trip.kmStart;
                
                // Main row
                const mainRow = document.createElement('tr');
                mainRow.innerHTML = `
                    <td rowspan="${trip.locations.length + 1}">${date}</td>
                    <td rowspan="${trip.locations.length + 1}">
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${vehicleColors[trip.vehicle]}"></div>
                            ${trip.vehicleName}
                        </span>
                    </td>
                    <td rowspan="${trip.locations.length + 1}"><strong>${trip.kmStart.toLocaleString('cs-CZ')}</strong></td>
                    <td rowspan="${trip.locations.length + 1}"><strong>${trip.kmEnd.toLocaleString('cs-CZ')}</strong></td>
                    <td rowspan="${trip.locations.length + 1}"><strong>${km} km</strong></td>
                    <td rowspan="${trip.locations.length + 1}"><strong>${trip.totalPallets || '-'}</strong></td>
                    <td colspan="2" style="background: #f8fafc; font-weight: 600;">M√≠sta:</td>
                `;
                tbody.appendChild(mainRow);
                
                // Location rows
                trip.locations.forEach((loc, idx) => {
                    const locRow = document.createElement('tr');
                    locRow.innerHTML = `
                        <td style="padding-left: 30px;">
                            <span style="color: #64748b;">‚Üí</span> ${loc.place}
                            ${loc.time ? `<span style="color: #64748b; font-size: 12px;"> (${loc.time})</span>` : ''}
                        </td>
                        <td style="text-align: center;">
                            ${loc.pallets ? `<span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">üì¶ ${loc.pallets}</span>` : '-'}
                        </td>
                    `;
                    tbody.appendChild(locRow);
                });
            });
        }

        // Analytics
        function updateAnalytics() {
            generateYearHeatmap(document.getElementById('heatmapYear').value);
            updateMiniStats();
            updateWeekdayActivityChart();
            updateTimelineChart();
            updateMonthlyComparisonChart();
            updateDistanceDistributionChart();
            updateEfficiencyChart();
            updateTopDestinationsChart();
            updateVehicleUtilizationChart();
            updateCumulativeKmChart();
        }

        function updateMiniStats() {
            // Nejdel≈°√≠ j√≠zda
            const longestTrip = Math.max(...filteredTripsData.map(t => t.kmEnd - t.kmStart), 0);
            document.getElementById('longestTrip').textContent = longestTrip.toLocaleString('cs-CZ') + ' km';
            
            // Nejv√≠ce palet za den
            const dailyPallets = {};
            filteredTripsData.forEach(t => {
                const date = t.date.split('T')[0];
                dailyPallets[date] = (dailyPallets[date] || 0) + t.totalPallets;
            });
            const maxPalletsDay = Math.max(...Object.values(dailyPallets), 0);
            document.getElementById('maxPalletsDay').textContent = maxPalletsDay.toLocaleString('cs-CZ');
            
            // Nejv√≠ce zast√°vek
            const maxStops = Math.max(...filteredTripsData.map(t => t.locations.length), 0);
            document.getElementById('maxStops').textContent = maxStops;
            
            // Pr≈Ømƒõr zast√°vek
            const avgStops = filteredTripsData.length > 0 
                ? (filteredTripsData.reduce((sum, t) => sum + t.locations.length, 0) / filteredTripsData.length).toFixed(1)
                : 0;
            document.getElementById('avgStops').textContent = avgStops;
        }

        function generateYearHeatmap(year) {
            const container = document.getElementById('yearHeatmap');
            container.innerHTML = '';

            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            
            // Calculate km per day
            const dailyKm = {};
            allTripsData.forEach(trip => {
                const tripYear = new Date(trip.date).getFullYear();
                if (tripYear === parseInt(year)) {
                    const dateStr = trip.date.split('T')[0];
                    dailyKm[dateStr] = (dailyKm[dateStr] || 0) + (trip.kmEnd - trip.kmStart);
                }
            });

            const maxKm = Math.max(...Object.values(dailyKm), 1);
            
            const weeks = [];
            let currentWeek = [];
            let currentDate = new Date(startDate);
            
            const firstDayOfWeek = startDate.getDay();
            const daysToAdd = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            for (let i = 0; i < daysToAdd; i++) {
                currentWeek.push(null);
            }

            while (currentDate <= endDate) {
                currentWeek.push(new Date(currentDate));
                
                if (currentWeek.length === 7 || currentDate.getTime() === endDate.getTime()) {
                    weeks.push([...currentWeek]);
                    currentWeek = [];
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            while (currentWeek.length > 0 && currentWeek.length < 7) {
                currentWeek.push(null);
            }
            if (currentWeek.length === 7) {
                weeks.push(currentWeek);
            }

            const heatmapHtml = document.createElement('div');
            heatmapHtml.className = 'heatmap-container';

            // Month labels
            const monthsRow = document.createElement('div');
            monthsRow.className = 'heatmap-months';
            monthsRow.innerHTML = '<div></div>';
            
            const monthNames = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåer', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
            let lastMonth = -1;
            weeks.forEach((week, weekIndex) => {
                const firstDay = week.find(d => d !== null);
                if (firstDay) {
                    const month = firstDay.getMonth();
                    if (month !== lastMonth && weekIndex > 0) {
                        monthsRow.innerHTML += `<div style="grid-column: span 1;">${monthNames[month]}</div>`;
                        lastMonth = month;
                    } else {
                        monthsRow.innerHTML += '<div></div>';
                    }
                } else {
                    monthsRow.innerHTML += '<div></div>';
                }
            });

            const weeksGrid = document.createElement('div');
            weeksGrid.className = 'heatmap-weeks';

            const dayLabels = document.createElement('div');
            dayLabels.className = 'heatmap-day-labels';
            dayLabels.innerHTML = `
                <div class="heatmap-day-label">Po</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label">St</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label">P√°</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label"></div>
            `;
            weeksGrid.appendChild(dayLabels);

            let activeDays = 0;
            let maxDayKm = 0;
            let maxDayDate = null;
            let totalActiveKm = 0;

            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'heatmap-week';

                week.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'heatmap-day';

                    if (day) {
                        const dateStr = day.toISOString().split('T')[0];
                        const km = dailyKm[dateStr] || 0;
                        
                        let level = 0;
                        if (km > 0) {
                            activeDays++;
                            totalActiveKm += km;
                            if (km > maxDayKm) {
                                maxDayKm = km;
                                maxDayDate = day;
                            }
                            const ratio = km / maxKm;
                            if (ratio > 0.75) level = 4;
                            else if (ratio > 0.5) level = 3;
                            else if (ratio > 0.25) level = 2;
                            else level = 1;
                        }

                        dayDiv.classList.add(`level-${level}`);
                        
                        dayDiv.addEventListener('mouseenter', function(e) {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'heatmap-tooltip';
                            const tripCount = allTripsData.filter(t => t.date.startsWith(dateStr)).length;
                            tooltip.innerHTML = `
                                <div><strong>${day.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'long', year: 'numeric' })}</strong></div>
                                <div>${km.toLocaleString('cs-CZ')} km${km > 0 ? ' ‚Ä¢ ' + tripCount + ' j√≠zd' : ''}</div>
                            `;
                            document.body.appendChild(tooltip);
                            
                            const rect = dayDiv.getBoundingClientRect();
                            tooltip.style.position = 'fixed';
                            tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
                            
                            dayDiv._tooltip = tooltip;
                        });
                        
                        dayDiv.addEventListener('mouseleave', function() {
                            if (dayDiv._tooltip) {
                                dayDiv._tooltip.remove();
                                delete dayDiv._tooltip;
                            }
                        });
                    } else {
                        dayDiv.style.background = 'transparent';
                        dayDiv.style.border = 'none';
                    }

                    weekDiv.appendChild(dayDiv);
                });

                weeksGrid.appendChild(weekDiv);
            });

            heatmapHtml.appendChild(monthsRow);
            heatmapHtml.appendChild(weeksGrid);
            container.appendChild(heatmapHtml);

            document.getElementById('heatmapActiveDays').textContent = activeDays;
            document.getElementById('heatmapMaxDay').textContent = maxDayDate ? maxDayDate.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'short' }) : '-';
            document.getElementById('heatmapMaxKm').textContent = maxDayKm.toLocaleString('cs-CZ') + ' km';
            document.getElementById('heatmapAvgKm').textContent = activeDays > 0 ? Math.round(totalActiveKm / activeDays).toLocaleString('cs-CZ') + ' km' : '0 km';
        }

        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;
            
            const hours = new Array(24).fill(0);
            filteredTripsData.forEach(trip => {
                trip.locations.forEach(loc => {
                    if (loc.time) {
                        const hour = parseInt(loc.time.split(':')[0]);
                        hours[hour]++;
                    }
                });
            });

            if (charts.timeline) charts.timeline.destroy();

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Poƒçet odjet√≠',
                        data: hours,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateEfficiencyChart() {
            const ctx = document.getElementById('efficiencyChart');
            if (!ctx) return;
            
            const vehicleEfficiency = {};
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const totalKm = vTrips.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
                const totalPallets = vTrips.reduce((sum, t) => sum + t.totalPallets, 0);
                vehicleEfficiency[v] = totalKm > 0 ? totalPallets / totalKm : 0;
            });

            if (charts.efficiency) charts.efficiency.destroy();

            charts.efficiency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vehicleEfficiency).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Palety na km',
                        data: Object.values(vehicleEfficiency),
                        backgroundColor: Object.keys(vehicleEfficiency).map(v => vehicleColors[v]),
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateCumulativeKmChart() {
            const ctx = document.getElementById('cumulativeKmChart');
            if (!ctx) return;
            
            const dailyKm = {};
            allTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                dailyKm[date] = (dailyKm[date] || 0) + (trip.kmEnd - trip.kmStart);
            });

            const sortedDates = Object.keys(dailyKm).sort();
            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += dailyKm[date];
                return cumulative;
            });

            if (charts.cumulative) charts.cumulative.destroy();

            charts.cumulative = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.slice(-90).map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' })),
                    datasets: [{
                        label: 'Kumulativn√≠ km',
                        data: cumulativeData.slice(-90),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateWeekdayActivityChart() {
            const ctx = document.getElementById('weekdayActivityChart');
            if (!ctx) return;
            
            const weekdays = ['Nedƒõle', 'Pondƒõl√≠', '√öter√Ω', 'St≈ôeda', 'ƒåtvrtek', 'P√°tek', 'Sobota'];
            const counts = new Array(7).fill(0);
            const kms = new Array(7).fill(0);
            
            filteredTripsData.forEach(trip => {
                const day = new Date(trip.date).getDay();
                counts[day]++;
                kms[day] += trip.kmEnd - trip.kmStart;
            });

            if (charts.weekdayActivity) charts.weekdayActivity.destroy();
            
            charts.weekdayActivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [
                        {
                            label: 'Poƒçet j√≠zd',
                            data: counts,
                            backgroundColor: '#2563eb',
                            borderRadius: 6
                        },
                        {
                            label: 'Kilometry',
                            data: kms,
                            backgroundColor: '#10b981',
                            borderRadius: 6
                        }
                    ]
                },
                options: { responsive: true }
            });
        }

        function updateTopDestinationsChart() {
            const ctx = document.getElementById('topDestinationsChart');
            if (!ctx) return;
            
            const destinations = {};
            filteredTripsData.forEach(trip => {
                trip.locations.forEach(loc => {
                    destinations[loc.place] = (destinations[loc.place] || 0) + 1;
                });
            });

            const sorted = Object.entries(destinations).sort((a, b) => b[1] - a[1]).slice(0, 10);

            if (charts.topDest) charts.topDest.destroy();
            
            charts.topDest = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        label: 'N√°v≈°tƒõv',
                        data: sorted.map(d => d[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart');
            if (!ctx) return;
            
            const monthlyData = {};
            allTripsData.forEach(trip => {
                const month = trip.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { km: 0, trips: 0, pallets: 0 };
                }
                monthlyData[month].km += trip.kmEnd - trip.kmStart;
                monthlyData[month].trips++;
                monthlyData[month].pallets += trip.totalPallets;
            });

            const months = Object.keys(monthlyData).sort().slice(-12);
            const labels = months.map(m => {
                const [year, month] = m.split('-');
                return `${month}/${year}`;
            });

            if (charts.monthlyComparison) charts.monthlyComparison.destroy();

            charts.monthlyComparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Kilometry', data: months.map(m => monthlyData[m].km), borderColor: '#2563eb', tension: 0.4 },
                        { label: 'J√≠zdy', data: months.map(m => monthlyData[m].trips), borderColor: '#10b981', tension: 0.4 },
                        { label: 'Palety', data: months.map(m => monthlyData[m].pallets), borderColor: '#f59e0b', tension: 0.4 }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false } }
            });
        }

        function updateDistanceDistributionChart() {
            const ctx = document.getElementById('distanceDistributionChart');
            if (!ctx) return;
            
            const ranges = { '0-50': 0, '51-100': 0, '101-150': 0, '151-200': 0, '201-300': 0, '300+': 0 };
            filteredTripsData.forEach(trip => {
                const km = trip.kmEnd - trip.kmStart;
                if (km <= 50) ranges['0-50']++;
                else if (km <= 100) ranges['51-100']++;
                else if (km <= 150) ranges['101-150']++;
                else if (km <= 200) ranges['151-200']++;
                else if (km <= 300) ranges['201-300']++;
                else ranges['300+']++;
            });

            if (charts.distDist) charts.distDist.destroy();

            charts.distDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges).map(r => r + ' km'),
                    datasets: [{
                        label: 'Poƒçet j√≠zd',
                        data: Object.values(ranges),
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateVehicleUtilizationChart() {
            const ctx = document.getElementById('vehicleUtilizationChart');
            if (!ctx) return;
            
            const totalDays = 30;
            const utilization = {};
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const uniqueDays = new Set(vTrips.map(t => t.date.split('T')[0])).size;
                utilization[v] = (uniqueDays / totalDays) * 100;
            });

            if (charts.vehicleUtil) charts.vehicleUtil.destroy();
            
            charts.vehicleUtil = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(utilization).map(v => vehicleNames[v]),
                    datasets: [{
                        data: Object.values(utilization),
                        backgroundColor: Object.keys(utilization).map(v => vehicleColors[v])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('vehicleFilter').addEventListener('change', () => {
            filterDataByDateRange();
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const sectionId = activeSection.id.replace('section-', '');
                loadSectionData(sectionId);
            }
        });

        document.getElementById('dateFrom').addEventListener('change', () => {
            filterDataByDateRange();
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const sectionId = activeSection.id.replace('section-', '');
                loadSectionData(sectionId);
            }
        });

        document.getElementById('dateTo').addEventListener('change', () => {
            filterDataByDateRange();
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const sectionId = activeSection.id.replace('section-', '');
                loadSectionData(sectionId);
            }
        });

        // Initialize
        initializeDateRange();
        loadAllData();
    </script>
</body>
</html>
