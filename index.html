<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kniha j√≠zd - Profesion√°ln√≠ port√°l</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Z√°kladn√≠ CSS ze souboru */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: #1e293b; color: white; padding: 30px 0; z-index: 200; }
        .sidebar h2 { padding: 0 25px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin: 5px 15px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; cursor: pointer; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: #2563eb; color: white; }
        .header { position: fixed; top: 0; left: 280px; right: 0; height: 70px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 100; }
        .main-content { margin-left: 280px; margin-top: 70px; padding: 30px; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-card-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .chart-container.full-width { grid-column: 1 / -1; }
        .chart-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        #map { height: 600px; border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: #f8fafc; font-weight: 700; }
        .vehicle-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 6px; font-size: 12px; }
        .vehicle-dot { width: 8px; height: 8px; border-radius: 50%; }
        .refresh-btn { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }

        /* Year Heatmap Styles */
        .heatmap-container { display: inline-block; }
        .heatmap-months { display: grid; grid-template-columns: 40px repeat(53, 12px); gap: 3px; margin-bottom: 5px; font-size: 11px; color: #64748b; }
        .heatmap-weeks { display: grid; grid-template-columns: 40px repeat(53, 12px); gap: 3px; }
        .heatmap-day-labels { display: flex; flex-direction: column; gap: 3px; font-size: 10px; color: #64748b; padding-top: 2px; }
        .heatmap-day-label { height: 12px; display: flex; align-items: center; }
        .heatmap-week { display: flex; flex-direction: column; gap: 3px; }
        .heatmap-day { width: 12px; height: 12px; border-radius: 2px; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(27, 31, 35, 0.06); }
        .heatmap-day:hover { border: 1px solid rgba(27, 31, 35, 0.3); transform: scale(1.3); z-index: 10; }
        .heatmap-day.level-0 { background: #ebedf0; }
        .heatmap-day.level-1 { background: #9be9a8; }
        .heatmap-day.level-2 { background: #40c463; }
        .heatmap-day.level-3 { background: #30a14e; }
        .heatmap-day.level-4 { background: #216e39; }
        .heatmap-tooltip { position: absolute; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 1000; white-space: nowrap; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üöõ Kniha j√≠zd</h2>
        <div class="nav-link active" data-section="dashboard">üìä Dashboard</div>
        <div class="nav-link" data-section="vehicles">üöö Vozidla</div>
        <div class="nav-link" data-section="routes">üó∫Ô∏è Trasy a mapa</div>
        <div class="nav-link" data-section="trips">üìù V≈°echny j√≠zdy</div>
        <div class="nav-link" data-section="analytics">üìà Analytika</div>
        <div class="nav-link" data-section="costs">üí∞ N√°klady</div>
    </div>

    <div class="header">
        <h1>Dashboard</h1>
        <div style="display: flex; gap: 20px; align-items: center;">
            <div>
                <input type="date" id="dateFrom" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <span>‚Äî</span>
                <input type="date" id="dateTo" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Obnovit</button>
        </div>
    </div>

    <div class="main-content">
        <div class="content-section active" id="section-dashboard">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">CELKEM KM</div>
                    <div class="stat-card-value" id="totalKm">0 km</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">POƒåET J√çZD</div>
                    <div class="stat-card-value" id="totalTrips">0</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">P≈òEPRAVENO PALET</div>
                    <div class="stat-card-value" id="totalPallets">0</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">PR≈ÆMƒöR KM/J√çZDA</div>
                    <div class="stat-card-value" id="avgKm">0 km</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Ujet√© kilometry dle vozidel</h3>
                    <canvas id="vehicleKmChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Rozlo≈æen√≠ j√≠zd</h3>
                    <canvas id="vehicleTripsChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Denn√≠ p≈ôehled kilometr≈Ø</h3>
                <canvas id="dailyKmChart"></canvas>
            </div>
        </div>

        <div class="content-section" id="section-vehicles">
            <h2 style="margin-bottom: 25px;">P≈ôehled vozidel</h2>
            <div id="vehicleStats"></div>
        </div>

        <div class="content-section" id="section-routes">
            <h2 style="margin-bottom: 25px;">Mapa tras</h2>
            <div style="background: white; padding: 25px; border-radius: 12px;">
                <div id="map"></div>
            </div>
        </div>

        <div class="content-section" id="section-trips">
            <h2 style="margin-bottom: 25px;">V≈°echny j√≠zdy</h2>
            <div style="background: white; border-radius: 12px; overflow: hidden;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Vozidlo</th>
                            <th>Km</th>
                            <th>Palety</th>
                            <th>Trasa</th>
                        </tr>
                    </thead>
                    <tbody id="tripsTable"></tbody>
                </table>
            </div>
        </div>

        <div class="content-section" id="section-analytics">
            <h2 style="margin-bottom: 25px;">Pokroƒçil√° analytika</h2>
            
            <!-- Roƒçn√≠ heatmapa -->
            <div class="chart-container full-width" style="margin-bottom: 30px;">
                <h3 class="chart-title">Roƒçn√≠ heatmapa najet√Ωch kilometr≈Ø</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <select id="heatmapYear" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <option value="2026">2026</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center; font-size: 12px; color: #64748b;">
                        <span>M√©nƒõ</span>
                        <div style="display: flex; gap: 3px;">
                            <div style="width: 15px; height: 15px; background: #ebedf0; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #9be9a8; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #40c463; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #30a14e; border-radius: 2px;"></div>
                            <div style="width: 15px; height: 15px; background: #216e39; border-radius: 2px;"></div>
                        </div>
                        <span>V√≠ce</span>
                    </div>
                </div>
                <div id="yearHeatmap" style="overflow-x: auto; padding: 20px; background: #f8fafc; border-radius: 8px;"></div>
                <div id="heatmapStats" style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Celkem dn≈Ø s j√≠zdami</div>
                        <div style="font-size: 20px; font-weight: 700;" id="activeDays">0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Nejaktivnƒõj≈°√≠ den</div>
                        <div style="font-size: 20px; font-weight: 700;" id="maxDay">-</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Max km za den</div>
                        <div style="font-size: 20px; font-weight: 700;" id="maxDayKm">0 km</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Pr≈Ømƒõr km/aktivn√≠ den</div>
                        <div style="font-size: 20px; font-weight: 700;" id="avgDayKm">0 km</div>
                    </div>
                </div>
            </div>

            <!-- Pokroƒçil√© grafy -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Rozlo≈æen√≠ dle dn√≠ v t√Ωdnu</h3>
                    <canvas id="weekdayChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Hodiny odjet√≠ (timeline)</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Mƒõs√≠ƒçn√≠ srovn√°n√≠ - Kilometry vs J√≠zdy vs Palety</h3>
                <canvas id="monthlyComparisonChart"></canvas>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Distribuce d√©lek j√≠zd</h3>
                    <canvas id="distanceDistributionChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Efektivita - Palety na km</h3>
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Top 15 nejƒçastƒõj≈°√≠ch destinac√≠</h3>
                    <canvas id="topDestinationsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Pr≈Ømƒõrn√Ω poƒçet zast√°vek na j√≠zdu</h3>
                    <canvas id="avgStopsChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3 class="chart-title">Kumulativn√≠ kilometry v roce</h3>
                <canvas id="cumulativeKmChart"></canvas>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Pomƒõr pr√°zdn√Ωch/nalo≈æen√Ωch km</h3>
                    <canvas id="loadRatioChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Pr≈Ømƒõrn√° vzd√°lenost mezi zast√°vkami</h3>
                    <canvas id="avgDistanceBetweenStopsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="content-section" id="section-costs">
            <h2 style="margin-bottom: 25px;">Anal√Ωza n√°klad≈Ø</h2>
            <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Nastaven√≠</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <label>Cena paliva (Kƒç/l):</label>
                        <input type="number" id="fuelPrice" value="38" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <div>
                        <label>Provozn√≠ n√°klady (Kƒç/km):</label>
                        <input type="number" id="operCost" value="5" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <div>
                        <button class="refresh-btn" onclick="calculateCosts()" style="margin-top: 28px; width: 100%;">P≈ôepoƒç√≠tat</button>
                    </div>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">N√ÅKLADY NA PALIVO</div>
                    <div class="stat-card-value" id="fuelCosts">0 Kƒç</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">PROVOZN√ç N√ÅKLADY</div>
                    <div class="stat-card-value" id="operCosts">0 Kƒç</div>
                </div>
                <div class="stat-card">
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">CELKOV√â N√ÅKLADY</div>
                    <div class="stat-card-value" id="totalCostValue">0 Kƒç</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://knihajizd.baborovsky-jakub.workers.dev';
        let allTripsData = [];
        let filteredTripsData = [];
        const charts = {};

        const vehicleNames = {
            'cervene-iveco': 'ƒåerven√© Iveco',
            'iveco-mysak': 'Iveco My≈°√°k',
            'atego': 'Atego',
            'peugeot': 'Peugeot'
        };

        function initializeDateRange() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            document.getElementById('dateFrom').value = formatDateForInput(thirtyDaysAgo);
            document.getElementById('dateTo').value = formatDateForInput(today);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
                document.querySelector('.header h1').textContent = this.textContent.trim();
            });
        });

        async function loadAllData() {
            try {
                const response = await fetch(`${API_URL}/get_trips.php`);
                const result = await response.json();
                if (result.success) {
                    allTripsData = result.trips;
                    filterDataByDateRange();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function filterDataByDateRange() {
            const dateFrom = new Date(document.getElementById('dateFrom').value);
            const dateTo = new Date(document.getElementById('dateTo').value);
            dateTo.setHours(23, 59, 59);
            filteredTripsData = allTripsData.filter(trip => {
                const tripDate = new Date(trip.date);
                return tripDate >= dateFrom && tripDate <= dateTo;
            });
        }

        function updateDashboard() {
            const totalKm = filteredTripsData.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
            const totalPallets = filteredTripsData.reduce((sum, t) => sum + t.totalPallets, 0);
            const avgKm = filteredTripsData.length > 0 ? (totalKm / filteredTripsData.length).toFixed(1) : 0;

            document.getElementById('totalKm').textContent = totalKm.toLocaleString('cs-CZ') + ' km';
            document.getElementById('totalTrips').textContent = filteredTripsData.length;
            document.getElementById('totalPallets').textContent = totalPallets.toLocaleString('cs-CZ');
            document.getElementById('avgKm').textContent = avgKm + ' km';

            updateVehicleKmChart();
            updateVehicleTripsChart();
            updateDailyKmChart();
        }

        function updateVehicleKmChart() {
            const ctx = document.getElementById('vehicleKmChart');
            const vehicleData = {};
            filteredTripsData.forEach(trip => {
                vehicleData[trip.vehicle] = (vehicleData[trip.vehicle] || 0) + (trip.kmEnd - trip.kmStart);
            });

            if (charts.vehicleKm) charts.vehicleKm.destroy();
            
            charts.vehicleKm = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vehicleData).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Kilometry',
                        data: Object.values(vehicleData),
                        backgroundColor: ['#dc2626', '#6b7280', '#64748b', '#1f2937']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateVehicleTripsChart() {
            const ctx = document.getElementById('vehicleTripsChart');
            const vehicleTrips = {};
            filteredTripsData.forEach(trip => {
                vehicleTrips[trip.vehicle] = (vehicleTrips[trip.vehicle] || 0) + 1;
            });

            if (charts.vehicleTrips) charts.vehicleTrips.destroy();

            charts.vehicleTrips = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(vehicleTrips).map(v => vehicleNames[v]),
                    datasets: [{
                        data: Object.values(vehicleTrips),
                        backgroundColor: ['#dc2626', '#6b7280', '#64748b', '#1f2937']
                    }]
                },
                options: { responsive: true }
            });
        }

        function updateDailyKmChart() {
            const ctx = document.getElementById('dailyKmChart');
            const dailyData = {};
            filteredTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                dailyData[date] = (dailyData[date] || 0) + (trip.kmEnd - trip.kmStart);
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' }));

            if (charts.dailyKm) charts.dailyKm.destroy();

            charts.dailyKm = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kilometry',
                        data: sortedDates.map(d => dailyData[d]),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function calculateCosts() {
            const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
            const operCost = parseFloat(document.getElementById('operCost').value);
            const consumption = { 'cervene-iveco': 25, 'iveco-mysak': 23, 'atego': 22, 'peugeot': 7 };

            let totalFuel = 0;
            let totalOper = 0;

            filteredTripsData.forEach(trip => {
                const km = trip.kmEnd - trip.kmStart;
                const fuel = (km / 100) * consumption[trip.vehicle];
                totalFuel += fuel * fuelPrice;
                totalOper += km * operCost;
            });

            document.getElementById('fuelCosts').textContent = Math.round(totalFuel).toLocaleString('cs-CZ') + ' Kƒç';
            document.getElementById('operCosts').textContent = Math.round(totalOper).toLocaleString('cs-CZ') + ' Kƒç';
            document.getElementById('totalCostValue').textContent = Math.round(totalFuel + totalOper).toLocaleString('cs-CZ') + ' Kƒç';
        }

        initializeDateRange();
        loadAllData();
        document.getElementById('dateFrom').addEventListener('change', () => { filterDataByDateRange(); updateDashboard(); });
        document.getElementById('dateTo').addEventListener('change', () => { filterDataByDateRange(); updateDashboard(); });

        // Advanced Analytics Functions

        // Generate Year Heatmap
        function generateYearHeatmap(year) {
            const container = document.getElementById('yearHeatmap');
            container.innerHTML = '';

            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            
            // Calculate km per day
            const dailyKm = {};
            allTripsData.forEach(trip => {
                const tripYear = new Date(trip.date).getFullYear();
                if (tripYear === parseInt(year)) {
                    const dateStr = trip.date.split('T')[0];
                    dailyKm[dateStr] = (dailyKm[dateStr] || 0) + (trip.kmEnd - trip.kmStart);
                }
            });

            // Find max km for scaling
            const maxKm = Math.max(...Object.values(dailyKm), 1);
            
            // Create weeks array
            const weeks = [];
            let currentWeek = [];
            let currentDate = new Date(startDate);
            
            // Pad beginning to start on Monday
            const firstDayOfWeek = startDate.getDay();
            const daysToAdd = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            for (let i = 0; i < daysToAdd; i++) {
                currentWeek.push(null);
            }

            while (currentDate <= endDate) {
                currentWeek.push(new Date(currentDate));
                
                if (currentWeek.length === 7 || currentDate.getTime() === endDate.getTime()) {
                    weeks.push([...currentWeek]);
                    currentWeek = [];
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Pad last week
            while (currentWeek.length > 0 && currentWeek.length < 7) {
                currentWeek.push(null);
            }
            if (currentWeek.length === 7) {
                weeks.push(currentWeek);
            }

            // Create heatmap HTML
            const heatmapHtml = document.createElement('div');
            heatmapHtml.className = 'heatmap-container';

            // Month labels
            const monthsRow = document.createElement('div');
            monthsRow.className = 'heatmap-months';
            monthsRow.innerHTML = '<div></div>'; // Empty cell for day labels
            
            const monthNames = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåer', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
            let lastMonth = -1;
            weeks.forEach((week, weekIndex) => {
                const firstDay = week.find(d => d !== null);
                if (firstDay) {
                    const month = firstDay.getMonth();
                    if (month !== lastMonth && weekIndex > 0) {
                        monthsRow.innerHTML += `<div style="grid-column: span 1;" class="heatmap-month-label">${monthNames[month]}</div>`;
                        lastMonth = month;
                    } else {
                        monthsRow.innerHTML += '<div></div>';
                    }
                } else {
                    monthsRow.innerHTML += '<div></div>';
                }
            });

            // Weeks grid
            const weeksGrid = document.createElement('div');
            weeksGrid.className = 'heatmap-weeks';

            // Day labels
            const dayLabels = document.createElement('div');
            dayLabels.className = 'heatmap-day-labels';
            dayLabels.innerHTML = `
                <div class="heatmap-day-label">Po</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label">St</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label">P√°</div>
                <div class="heatmap-day-label"></div>
                <div class="heatmap-day-label"></div>
            `;
            weeksGrid.appendChild(dayLabels);

            // Statistics
            let activeDays = 0;
            let maxDayKm = 0;
            let maxDayDate = null;
            let totalActiveKm = 0;

            // Create weeks
            weeks.forEach(week => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'heatmap-week';

                week.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'heatmap-day';

                    if (day) {
                        const dateStr = day.toISOString().split('T')[0];
                        const km = dailyKm[dateStr] || 0;
                        
                        // Calculate level (0-4)
                        let level = 0;
                        if (km > 0) {
                            activeDays++;
                            totalActiveKm += km;
                            if (km > maxDayKm) {
                                maxDayKm = km;
                                maxDayDate = day;
                            }
                            const ratio = km / maxKm;
                            if (ratio > 0.75) level = 4;
                            else if (ratio > 0.5) level = 3;
                            else if (ratio > 0.25) level = 2;
                            else level = 1;
                        }

                        dayDiv.classList.add(`level-${level}`);
                        dayDiv.setAttribute('data-date', dateStr);
                        dayDiv.setAttribute('data-km', km);
                        
                        // Tooltip
                        dayDiv.addEventListener('mouseenter', function(e) {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'heatmap-tooltip';
                            tooltip.innerHTML = `
                                <div><strong>${day.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'long', year: 'numeric' })}</strong></div>
                                <div>${km} km${km > 0 ? ' ‚Ä¢ ' + Math.round(dailyKm[dateStr] ? allTripsData.filter(t => t.date.startsWith(dateStr)).length : 0) + ' j√≠zd' : ''}</div>
                            `;
                            document.body.appendChild(tooltip);
                            
                            const rect = dayDiv.getBoundingClientRect();
                            tooltip.style.position = 'fixed';
                            tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
                            
                            dayDiv._tooltip = tooltip;
                        });
                        
                        dayDiv.addEventListener('mouseleave', function() {
                            if (dayDiv._tooltip) {
                                dayDiv._tooltip.remove();
                                delete dayDiv._tooltip;
                            }
                        });
                    } else {
                        dayDiv.style.background = 'transparent';
                        dayDiv.style.border = 'none';
                    }

                    weekDiv.appendChild(dayDiv);
                });

                weeksGrid.appendChild(weekDiv);
            });

            heatmapHtml.appendChild(monthsRow);
            heatmapHtml.appendChild(weeksGrid);
            container.appendChild(heatmapHtml);

            // Update stats
            document.getElementById('activeDays').textContent = activeDays;
            document.getElementById('maxDay').textContent = maxDayDate ? maxDayDate.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'short' }) : '-';
            document.getElementById('maxDayKm').textContent = maxDayKm.toLocaleString('cs-CZ') + ' km';
            document.getElementById('avgDayKm').textContent = activeDays > 0 ? Math.round(totalActiveKm / activeDays).toLocaleString('cs-CZ') + ' km' : '0 km';
        }

        document.getElementById('heatmapYear').addEventListener('change', function() {
            generateYearHeatmap(this.value);
        });

        // Update analytics when data loads
        function updateAdvancedAnalytics() {
            generateYearHeatmap(document.getElementById('heatmapYear').value);
            updateTimelineChart();
            updateMonthlyComparisonChart();
            updateDistanceDistributionChart();
            updateEfficiencyChart();
            updateTopDestinationsChart();
            updateAvgStopsChart();
            updateCumulativeKmChart();
            updateLoadRatioChart();
            updateAvgDistanceBetweenStopsChart();
        }

        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            const hours = new Array(24).fill(0);
            
            filteredTripsData.forEach(trip => {
                trip.locations.forEach(loc => {
                    if (loc.time) {
                        const hour = parseInt(loc.time.split(':')[0]);
                        hours[hour]++;
                    }
                });
            });

            if (charts.timeline) charts.timeline.destroy();

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Poƒçet odjet√≠',
                        data: hours,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart');
            const monthlyData = {};
            
            allTripsData.forEach(trip => {
                const month = trip.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { km: 0, trips: 0, pallets: 0 };
                }
                monthlyData[month].km += trip.kmEnd - trip.kmStart;
                monthlyData[month].trips++;
                monthlyData[month].pallets += trip.totalPallets;
            });

            const months = Object.keys(monthlyData).sort().slice(-12);
            const labels = months.map(m => {
                const [year, month] = m.split('-');
                return `${month}/${year}`;
            });

            if (charts.monthlyComparison) charts.monthlyComparison.destroy();

            charts.monthlyComparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Kilometry',
                            data: months.map(m => monthlyData[m].km),
                            borderColor: '#2563eb',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'J√≠zdy',
                            data: months.map(m => monthlyData[m].trips),
                            borderColor: '#10b981',
                            yAxisID: 'y1',
                            tension: 0.4
                        },
                        {
                            label: 'Palety',
                            data: months.map(m => monthlyData[m].pallets),
                            borderColor: '#f59e0b',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left' },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function updateDistanceDistributionChart() {
            const ctx = document.getElementById('distanceDistributionChart');
            const ranges = { '0-50': 0, '51-100': 0, '101-150': 0, '151-200': 0, '201-300': 0, '300+': 0 };
            
            filteredTripsData.forEach(trip => {
                const km = trip.kmEnd - trip.kmStart;
                if (km <= 50) ranges['0-50']++;
                else if (km <= 100) ranges['51-100']++;
                else if (km <= 150) ranges['101-150']++;
                else if (km <= 200) ranges['151-200']++;
                else if (km <= 300) ranges['201-300']++;
                else ranges['300+']++;
            });

            if (charts.distDist) charts.distDist.destroy();

            charts.distDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges).map(r => r + ' km'),
                    datasets: [{
                        label: 'Poƒçet j√≠zd',
                        data: Object.values(ranges),
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateEfficiencyChart() {
            const ctx = document.getElementById('efficiencyChart');
            const vehicleEfficiency = {};
            
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const totalKm = vTrips.reduce((sum, t) => sum + (t.kmEnd - t.kmStart), 0);
                const totalPallets = vTrips.reduce((sum, t) => sum + t.totalPallets, 0);
                vehicleEfficiency[v] = totalPallets > 0 ? totalPallets / totalKm : 0;
            });

            if (charts.efficiency) charts.efficiency.destroy();

            charts.efficiency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(vehicleEfficiency).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Palety na km',
                        data: Object.values(vehicleEfficiency),
                        backgroundColor: ['#dc2626', '#6b7280', '#64748b', '#1f2937'],
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateTopDestinationsChart() {
            const ctx = document.getElementById('topDestinationsChart');
            const destinations = {};
            
            filteredTripsData.forEach(trip => {
                trip.locations.forEach(loc => {
                    destinations[loc.place] = (destinations[loc.place] || 0) + 1;
                });
            });

            const sorted = Object.entries(destinations).sort((a, b) => b[1] - a[1]).slice(0, 15);

            if (charts.topDest) charts.topDest.destroy();

            charts.topDest = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        label: 'N√°v≈°tƒõv',
                        data: sorted.map(d => d[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateAvgStopsChart() {
            const ctx = document.getElementById('avgStopsChart');
            const avgStops = {};
            
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const totalStops = vTrips.reduce((sum, t) => sum + t.locations.length, 0);
                avgStops[v] = vTrips.length > 0 ? totalStops / vTrips.length : 0;
            });

            if (charts.avgStops) charts.avgStops.destroy();

            charts.avgStops = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(avgStops).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Pr≈Ømƒõr zast√°vek',
                        data: Object.values(avgStops),
                        backgroundColor: ['#dc2626', '#6b7280', '#64748b', '#1f2937'],
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateCumulativeKmChart() {
            const ctx = document.getElementById('cumulativeKmChart');
            const dailyKm = {};
            
            allTripsData.forEach(trip => {
                const date = trip.date.split('T')[0];
                dailyKm[date] = (dailyKm[date] || 0) + (trip.kmEnd - trip.kmStart);
            });

            const sortedDates = Object.keys(dailyKm).sort();
            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += dailyKm[date];
                return cumulative;
            });

            if (charts.cumulative) charts.cumulative.destroy();

            charts.cumulative = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.slice(-90).map(d => new Date(d).toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit' })),
                    datasets: [{
                        label: 'Kumulativn√≠ km',
                        data: cumulativeData.slice(-90),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateLoadRatioChart() {
            const ctx = document.getElementById('loadRatioChart');
            
            const loaded = filteredTripsData.filter(t => t.totalPallets > 0).length;
            const empty = filteredTripsData.filter(t => t.totalPallets === 0).length;

            if (charts.loadRatio) charts.loadRatio.destroy();

            charts.loadRatio = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Nalo≈æen√© j√≠zdy', 'Pr√°zdn√© j√≠zdy'],
                    datasets: [{
                        data: [loaded, empty],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true }
            });
        }

        function updateAvgDistanceBetweenStopsChart() {
            const ctx = document.getElementById('avgDistanceBetweenStopsChart');
            const avgDist = {};
            
            Object.keys(vehicleNames).forEach(v => {
                const vTrips = filteredTripsData.filter(t => t.vehicle === v);
                const totalDist = vTrips.reduce((sum, t) => {
                    const km = t.kmEnd - t.kmStart;
                    const stops = t.locations.length;
                    return sum + (stops > 1 ? km / (stops - 1) : 0);
                }, 0);
                avgDist[v] = vTrips.length > 0 ? totalDist / vTrips.length : 0;
            });

            if (charts.avgDistStops) charts.avgDistStops.destroy();

            charts.avgDistStops = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(avgDist).map(v => vehicleNames[v]),
                    datasets: [{
                        label: 'Km mezi zast√°vkami',
                        data: Object.values(avgDist),
                        backgroundColor: ['#dc2626', '#6b7280', '#64748b', '#1f2937'],
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // Update the loadAllData function to include advanced analytics
        const originalLoadAllData = loadAllData;
        loadAllData = async function() {
            await originalLoadAllData();
            updateAdvancedAnalytics();
        };
    </script>
</body>
</html>
